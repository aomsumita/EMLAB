#include <ESP32Servo.h>


#define IR_START_PIN 35  // IR Sensor à¸ˆà¸¸à¸”à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
#define IR_END_PIN 27    // IR Sensor à¸ˆà¸¸à¸”à¸›à¸¥à¸²à¸¢
#define SERVO_PIN 25     // à¸‚à¸²à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Servo
#define BUTTON_PIN 16    // à¸›à¸¸à¹ˆà¸¡à¸à¸”à¸£à¸µà¹€à¸‹à¹‡à¸• Servo

Servo myservo;
bool timing = false;      // à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²
bool finished = false;    // à¸ˆà¸šà¸£à¸­à¸šà¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡
unsigned long startTime;  // à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡à¸™à¸±à¸š
unsigned long endTime;    // à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”
const float servoResponseTime = 0.15; 

// à¸•à¸±à¸§à¹à¸›à¸£à¸ªà¸³à¸«à¸£à¸±à¸š debounce
int lastButtonState = HIGH; // à¸ªà¸–à¸²à¸™à¸°à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸‚à¸­à¸‡à¸›à¸¸à¹ˆà¸¡ (HIGH = à¹„à¸¡à¹ˆà¸à¸”)
unsigned long lastDebounceTime = 0; // à¹€à¸§à¸¥à¸²à¸à¸”à¸›à¸¸à¹ˆà¸¡à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
const unsigned long debounceDelay = 50; // à¸”à¸µà¹€à¸¥à¸¢à¹Œà¸à¸±à¸™à¸à¸²à¸£à¹€à¸”à¹‰à¸‡à¸‚à¸­à¸‡à¸›à¸¸à¹ˆà¸¡ (50ms)

void setup() {
    Serial.begin(115200);
    pinMode(IR_START_PIN, INPUT);
    pinMode(IR_END_PIN, INPUT);
    pinMode(BUTTON_PIN, INPUT_PULLUP);
    
    myservo.attach(SERVO_PIN);
    myservo.write(0);  // à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸—à¸µà¹ˆ 0 à¸­à¸‡à¸¨à¸²
}


void loop() {
    int startSensor = digitalRead(IR_START_PIN);
    int endSensor = digitalRead(IR_END_PIN);
    int buttonState = digitalRead(BUTTON_PIN);

    // à¹€à¸£à¸´à¹ˆà¸¡à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸² (à¹€à¸‰à¸žà¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸£à¸´à¹ˆà¸¡à¸¡à¸²à¸à¹ˆà¸­à¸™)
    if (startSensor == LOW && !timing && !finished) {
        startTime = millis();
        timing = true;
        Serial.println("ðŸš€ à¹€à¸£à¸´à¹ˆà¸¡à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²!");
    }

    // à¸«à¸¢à¸¸à¸”à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²à¹à¸¥à¸°à¸„à¸³à¸™à¸§à¸“à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§ (à¹€à¸‰à¸žà¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²à¸­à¸¢à¸¹à¹ˆ)
    if (endSensor == LOW && timing) {
        endTime = millis();
        unsigned long totalTime = endTime - startTime; // à¹€à¸§à¸¥à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (ms)
        float timeInSeconds = totalTime / 1000.0; // à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸§à¸´à¸™à¸²à¸—à¸µ

        // à¸„à¸³à¸™à¸§à¸“à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§ V = s / t (s = 5 cm)
        float distance = 5.0; // à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡ (cm)
        float velocity = distance / timeInSeconds; // à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§ (cm/s)

        Serial.print("ðŸ à¹€à¸§à¸¥à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: ");
        Serial.print(timeInSeconds);
        Serial.println(" à¸§à¸´à¸™à¸²à¸—à¸µ");

        Serial.print("âš¡ à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§: ");
        Serial.print(velocity);
        Serial.println(" cm/s");

        // à¸„à¸³à¸™à¸§à¸“à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¹„à¸¡à¹‰à¸à¸±à¹‰à¸™à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¹ƒà¸™à¸à¸²à¸£à¸¥à¸‡à¸ˆà¸²à¸à¸ªà¸¹à¸•à¸£ s = v*t - (1/2) a * t^2
        float s = 30.0; // à¸£à¸°à¸¢à¸°à¸—à¸µà¹ˆà¹„à¸¡à¹‰à¸à¸±à¹‰à¸™à¸•à¹‰à¸­à¸‡à¸¥à¸‡ (cm)
        float a = 9.81; // à¸„à¸§à¸²à¸¡à¹€à¸£à¹ˆà¸‡à¹‚à¸™à¹‰à¸¡à¸–à¹ˆà¸§à¸‡ (cm/s^2)
        
        // à¹ƒà¸Šà¹‰à¸ªà¸¡à¸à¸²à¸£ s = vt - (1/2)at^2
        // à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸ªà¸¡à¸à¸²à¸£à¸à¸³à¸¥à¸±à¸‡à¸ªà¸­à¸‡: 0.5 * a * t^2 - v * t + s = 0
        float t1, t2;
        float discriminant = (velocity * velocity) - (2 * a * s);

        if (discriminant >= 0) {
            t1 = (velocity - sqrt(discriminant)) / a;
            t2 = (velocity + sqrt(discriminant)) / a;

            // à¹€à¸¥à¸·à¸­à¸à¸„à¹ˆà¸² t à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸šà¸§à¸
            float servoTime = (t1 > 0) ? t1 : t2;

            // à¸„à¸³à¸™à¸§à¸“à¹€à¸§à¸¥à¸²à¸«à¸™à¹ˆà¸§à¸‡à¸—à¸µà¹ˆà¸Šà¸”à¹€à¸Šà¸¢à¹€à¸§à¸¥à¸²à¸•à¸­à¸šà¸ªà¸™à¸­à¸‡à¸‚à¸­à¸‡à¹€à¸‹à¸­à¸£à¹Œà¹‚à¸§
            float delayTime = servoTime - servoResponseTime;
            if (delayTime < 0) delayTime = 0; // à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸„à¹ˆà¸²à¸•à¸´à¸”à¸¥à¸š

            Serial.print("â³ à¹€à¸§à¸¥à¸²à¹„à¸¡à¹‰à¸à¸±à¹‰à¸™à¸¥à¸‡: ");
            Serial.print(servoTime);
            Serial.println(" à¸§à¸´à¸™à¸²à¸—à¸µ");

            Serial.print("â³ à¸«à¸™à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸à¹ˆà¸­à¸™à¸ªà¸±à¸šà¹„à¸¡à¹‰à¸à¸±à¹‰à¸™: ");
            Serial.print(delayTime);
            Serial.println(" à¸§à¸´à¸™à¸²à¸—à¸µ");

            // à¸«à¸™à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸à¹ˆà¸­à¸™à¹ƒà¸«à¹‰à¹„à¸¡à¹‰à¸à¸±à¹‰à¸™à¸¥à¸‡ (à¸Šà¸”à¹€à¸Šà¸¢à¹€à¸§à¸¥à¸²à¸•à¸­à¸šà¸ªà¸™à¸­à¸‡à¸‚à¸­à¸‡à¹€à¸‹à¸­à¸£à¹Œà¹‚à¸§)
            delay(delayTime * 1000);

            // à¸ªà¸±à¸šà¹„à¸¡à¹‰à¸à¸±à¹‰à¸™à¸¥à¸‡
            myservo.write(90); // à¸›à¸£à¸±à¸šà¸¡à¸¸à¸¡à¹ƒà¸«à¹‰à¹„à¸¡à¹‰à¸à¸±à¹‰à¸™à¸¥à¸‡
            Serial.println("ðŸ”» à¹„à¸¡à¹‰à¸à¸±à¹‰à¸™à¸¥à¸‡à¹à¸¥à¹‰à¸§!");
        } else {
            Serial.println("âš ï¸ à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸„à¸³à¸™à¸§à¸“à¹„à¸¡à¹ˆà¹„à¸”à¹‰ (à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸à¸ˆà¸£à¸´à¸‡)");
        }

        timing = false;  // à¸«à¸¢à¸¸à¸”à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²
        finished = true; // à¹€à¸‹à¹‡à¸•à¸§à¹ˆà¸²à¸£à¸­à¸šà¸™à¸µà¹‰à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§
    }

    // à¸à¸”à¸›à¸¸à¹ˆà¸¡ â†’ à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸°à¸šà¸šà¹€à¸žà¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸­à¸šà¹ƒà¸«à¸¡à¹ˆ
    if (buttonState == LOW) {
        Serial.println("ðŸ”„ à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸°à¸šà¸š!");
        myservo.write(0);  // à¸£à¸µà¹€à¸‹à¹‡à¸•à¹„à¸¡à¹‰à¸à¸±à¹‰à¸™à¸à¸¥à¸±à¸šà¸‚à¸¶à¹‰à¸™
        finished = false; // à¸žà¸£à¹‰à¸­à¸¡à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸­à¸šà¹ƒà¸«à¸¡à¹ˆ
        delay(300);  // à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£à¸à¸”à¸‹à¹‰à¸³à¹€à¸£à¹‡à¸§à¹€à¸à¸´à¸™à¹„à¸›
    }
}
